[tox]
envlist = py{39,310}{,-devdeps,-oldestdeps},build_docs,codestyle
requires =
    setuptools >= 30.3.0
    pip >= 21.0.1
    tox-pypi-filter >= 0.12

[testenv]
passenv = CC
setenv =
    MPLBACKEND = agg
    COLUMNS = 180
    PYTEST_COMMAND = pytest --cov=dkist --cov-config={toxinidir}/setup.cfg --verbose --timeout=120
extras = test
commands = {env:PYTEST_COMMAND} {posargs}
description =
    run tests
    devdeps: with the latest developer version of key dependencies
    oldestdeps: with the oldest supported version of all dependencies
deps =
    pytest-timeout

    # Devdeps installs our key dependancies from git to ensure we catch future
    # breaking changes before they make it to release
    devdeps: git+https://github.com/astropy/astropy
    devdeps: git+https://https://github.com/alecthomas/voluptuous
    devdeps: git+https://https://github.com/yaml/pyyaml

    # The oldest deps build runs all our tests against the oldest supported
    # versions
    oldestdeps: astropy<4.0
    oldestdeps: voluptuous<1.0.0
    oldestdeps: pyyaml<6.0
    oldestdeps: dkist-fits-specifications==0.9.1

[testenv:codestyle]
skip_install = true
description = Run all style and file checks with pre-commit
deps =
    pre-commit
commands =
    pre-commit install --install-hooks
    pre-commit run --all-files {posargs}
